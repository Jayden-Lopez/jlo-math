function checkMultipleChoice(topic, selectedIndex) {
            const question = window.currentQuestion;
            const buttons = document.querySelectorAll(`#${topic}-answers .answer-btn`);
            const feedback = document.getElementById(`${topic}-feedback`);
            
            totalAttempts++;
            topicStats[topic].attempted++;
            
            const isCorrect = selectedIndex === question.correct;
            
            // Track problem in history
            problemHistory.push({
                topic: topic<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jordan's Personalized Math Practice</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #2c3e50;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.1em;
            color: #34495e;
        }

        .score-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .score-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .score-box .label {
            font-size: 0.9em;
            color: #666;
        }

        .score-box .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
        }

        .main-content {
            padding: 30px;
        }

        .topic-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .topic-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .topic-card.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .topic-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .topic-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .topic-level {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .skill-tag {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .practice-area {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .practice-area.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .question-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .question-text {
            font-size: 1.3em;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .hint-box {
            background: #fff9e6;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #ffd93d;
            display: none;
        }

        .hint-box.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .answer-btn {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .answer-btn:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .answer-btn.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .answer-btn.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .answer-input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            width: 100%;
            margin-bottom: 15px;
        }

        .answer-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-success {
            background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .feedback-message {
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .feedback-message.correct {
            background: linear-gradient(135deg, #d4edda 0%, #a8e6cf 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-message.incorrect {
            background: linear-gradient(135deg, #f8d7da 0%, #ffb3ba 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-tracker {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .progress-bar {
            background: #e0e0e0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c9ff 0%, #92fe9d 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .step-explanation {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }

        .step {
            margin-bottom: 15px;
            padding-left: 20px;
            position: relative;
        }

        .step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            background: #2196F3;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }

        @media (max-width: 768px) {
            .topic-selector {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Jordan's Math Practice Zone</h1>
            <p>Based on IXL Diagnostic Results - September 17, 2025</p>
            <div class="score-display">
                <div class="score-box">
                    <div class="label">Overall Math Level</div>
                    <div class="value">460</div>
                </div>
                <div class="score-box">
                    <div class="label">Projected Level</div>
                    <div class="value" id="projectedLevel" style="color: #10b981;">460</div>
                </div>
                <div class="score-box">
                    <div class="label">Target Level</div>
                    <div class="value">600+</div>
                </div>
                <div class="score-box">
                    <div class="label">Problems Completed</div>
                    <div class="value" id="completedCount">0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Choose a Topic to Practice:</h2>
            
            <div class="topic-selector">
                <div class="topic-card" onclick="selectTopic('fractions')">
                    <span class="skill-tag">Need Work</span>
                    <div class="topic-icon">ü•ß</div>
                    <div class="topic-title">Fractions</div>
                    <div class="topic-level">Level: 520</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('operations')">
                    <span class="skill-tag">Focus Area</span>
                    <div class="topic-icon">‚ûï</div>
                    <div class="topic-title">Operations</div>
                    <div class="topic-level">Level: 500</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('algebra')">
                    <div class="topic-icon">üî§</div>
                    <div class="topic-title">Algebra</div>
                    <div class="topic-level">Level: 480</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('word-problems')">
                    <div class="topic-icon">üìñ</div>
                    <div class="topic-title">Word Problems</div>
                    <div class="topic-level">Level: 480</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('geometry')">
                    <span class="skill-tag">Need Work</span>
                    <div class="topic-icon">üìê</div>
                    <div class="topic-title">Geometry</div>
                    <div class="topic-level">Level: 380</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('measurement')">
                    <div class="topic-icon">üìè</div>
                    <div class="topic-title">Measurement</div>
                    <div class="topic-level">Level: 420</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('ratios')" style="border-color: #ff9800;">
                    <span class="skill-tag" style="background: #ff9800;">Grade 6</span>
                    <div class="topic-icon">‚öñÔ∏è</div>
                    <div class="topic-title">Ratios & Rates</div>
                    <div class="topic-level">New Topic</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('integers')" style="border-color: #ff9800;">
                    <span class="skill-tag" style="background: #ff9800;">Grade 6</span>
                    <div class="topic-icon">‚ûñ</div>
                    <div class="topic-title">Negative Numbers</div>
                    <div class="topic-level">New Topic</div>
                </div>
                
                <div class="topic-card" onclick="selectTopic('expressions')" style="border-color: #ff9800;">
                    <span class="skill-tag" style="background: #ff9800;">Grade 6</span>
                    <div class="topic-icon">üìù</div>
                    <div class="topic-title">Expressions</div>
                    <div class="topic-level">Advanced</div>
                </div>
            </div>

            <!-- Practice Areas -->
            <div id="fractions-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">ü•ß Fractions Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="fractions-question"></div>
                    <div class="hint-box" id="fractions-hint">
                        <strong>üí° Hint:</strong> <span id="fractions-hint-text"></span>
                    </div>
                    <div id="fractions-answers" class="answer-options"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('fractions')">Show Hint</button>
                        <button class="btn btn-primary" onclick="nextQuestion('fractions')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="fractions-feedback"></div>
                </div>
            </div>

            <div id="operations-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">‚ûï Operations Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="operations-question"></div>
                    <div class="hint-box" id="operations-hint">
                        <strong>üí° Hint:</strong> <span id="operations-hint-text"></span>
                    </div>
                    <input type="number" class="answer-input" id="operations-answer" placeholder="Enter your answer">
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('operations')">Show Hint</button>
                        <button class="btn btn-primary" onclick="checkAnswer('operations')">Check Answer</button>
                        <button class="btn btn-success" onclick="nextQuestion('operations')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="operations-feedback"></div>
                </div>
            </div>

            <div id="algebra-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">üî§ Algebra Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="algebra-question"></div>
                    <div class="hint-box" id="algebra-hint">
                        <strong>üí° Hint:</strong> <span id="algebra-hint-text"></span>
                    </div>
                    <div id="algebra-answers" class="answer-options"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('algebra')">Show Hint</button>
                        <button class="btn btn-primary" onclick="nextQuestion('algebra')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="algebra-feedback"></div>
                </div>
            </div>

            <div id="word-problems-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">üìñ Word Problems Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="word-problems-question"></div>
                    <div class="hint-box" id="word-problems-hint">
                        <strong>üí° Hint:</strong> <span id="word-problems-hint-text"></span>
                    </div>
                    <input type="number" class="answer-input" id="word-problems-answer" placeholder="Enter your answer">
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('word-problems')">Show Hint</button>
                        <button class="btn btn-primary" onclick="checkAnswer('word-problems')">Check Answer</button>
                        <button class="btn btn-success" onclick="nextQuestion('word-problems')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="word-problems-feedback"></div>
                    <div class="step-explanation" id="word-problems-steps" style="display: none;"></div>
                </div>
            </div>

            <div id="geometry-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">üìê Geometry Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="geometry-question"></div>
                    <div class="hint-box" id="geometry-hint">
                        <strong>üí° Hint:</strong> <span id="geometry-hint-text"></span>
                    </div>
                    <input type="number" class="answer-input" id="geometry-answer" placeholder="Enter your answer">
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('geometry')">Show Hint</button>
                        <button class="btn btn-primary" onclick="checkAnswer('geometry')">Check Answer</button>
                        <button class="btn btn-success" onclick="nextQuestion('geometry')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="geometry-feedback"></div>
                </div>
            </div>

            <div id="measurement-practice" class="practice-area">
                <h3 style="color: #667eea; margin-bottom: 20px;">üìè Measurement Practice</h3>
                <div class="question-container">
                    <div class="question-text" id="measurement-question"></div>
                    <div class="hint-box" id="measurement-hint">
                        <strong>üí° Hint:</strong> <span id="measurement-hint-text"></span>
                    </div>
                    <div id="measurement-answers" class="answer-options"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('measurement')">Show Hint</button>
                        <button class="btn btn-primary" onclick="nextQuestion('measurement')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="measurement-feedback"></div>
                </div>
            </div>

            <div id="ratios-practice" class="practice-area">
                <h3 style="color: #ff9800; margin-bottom: 20px;">‚öñÔ∏è Ratios & Rates (6th Grade Preview)</h3>
                <div class="question-container">
                    <div class="question-text" id="ratios-question"></div>
                    <div class="hint-box" id="ratios-hint">
                        <strong>üí° Hint:</strong> <span id="ratios-hint-text"></span>
                    </div>
                    <input type="text" class="answer-input" id="ratios-answer" placeholder="Enter your answer">
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('ratios')">Show Hint</button>
                        <button class="btn btn-primary" onclick="checkAnswer('ratios')">Check Answer</button>
                        <button class="btn btn-success" onclick="nextQuestion('ratios')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="ratios-feedback"></div>
                    <div class="step-explanation" id="ratios-steps" style="display: none;"></div>
                </div>
            </div>

            <div id="integers-practice" class="practice-area">
                <h3 style="color: #ff9800; margin-bottom: 20px;">‚ûñ Negative Numbers (6th Grade Preview)</h3>
                <div class="question-container">
                    <div class="question-text" id="integers-question"></div>
                    <div class="hint-box" id="integers-hint">
                        <strong>üí° Hint:</strong> <span id="integers-hint-text"></span>
                    </div>
                    <input type="text" class="answer-input" id="integers-answer" placeholder="Enter your answer (use - for negative)">
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('integers')">Show Hint</button>
                        <button class="btn btn-primary" onclick="checkAnswer('integers')">Check Answer</button>
                        <button class="btn btn-success" onclick="nextQuestion('integers')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="integers-feedback"></div>
                </div>
            </div>

            <div id="expressions-practice" class="practice-area">
                <h3 style="color: #ff9800; margin-bottom: 20px;">üìù Expressions & Equations (6th Grade Preview)</h3>
                <div class="question-container">
                    <div class="question-text" id="expressions-question"></div>
                    <div class="hint-box" id="expressions-hint">
                        <strong>üí° Hint:</strong> <span id="expressions-hint-text"></span>
                    </div>
                    <div id="expressions-answers" class="answer-options"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showHint('expressions')">Show Hint</button>
                        <button class="btn btn-primary" onclick="nextQuestion('expressions')">Next Question</button>
                    </div>
                    <div class="feedback-message" id="expressions-feedback"></div>
                    <div class="step-explanation" id="expressions-steps" style="display: none;"></div>
                </div>
            </div>

            <div class="progress-tracker">
                <h3>üìä Your Progress Today</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
                </div>
                <p style="margin-top: 10px;">Complete 10 problems to reach today's goal!</p>
            </div>

            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 15px; border: 2px solid #0ea5e9;">
                <h3 style="color: #0369a1; margin-bottom: 20px;">üë®‚Äçüë©‚Äçüë¶ Parent Dashboard</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="color: #666; font-size: 0.9em;">Total Problems Attempted</div>
                        <div style="font-size: 1.8em; color: #0369a1; font-weight: bold;" id="totalAttempted">0</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="color: #666; font-size: 0.9em;">Correct Answers</div>
                        <div style="font-size: 1.8em; color: #10b981; font-weight: bold;" id="correctAnswers">0</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="color: #666; font-size: 0.9em;">Accuracy Rate</div>
                        <div style="font-size: 1.8em; color: #8b5cf6; font-weight: bold;" id="accuracyRate">0%</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="color: #666; font-size: 0.9em;">Time Spent Today</div>
                        <div style="font-size: 1.8em; color: #f59e0b; font-weight: bold;" id="timeSpent">0m</div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 15px;">Performance by Topic</h4>
                    <div id="topicPerformance" style="display: grid; gap: 10px;">
                        <!-- Topic performance will be inserted here -->
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #0369a1; margin-bottom: 15px;">Areas Needing Attention</h4>
                    <div id="needsAttention" style="color: #dc2626;">
                        <!-- Will be populated with struggling topics -->
                    </div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="generateParentReport()" style="background: linear-gradient(135deg, #0ea5e9 0%, #0369a1 100%);">
                        üìß Generate Email Report
                    </button>
                    <button class="btn btn-secondary" onclick="showDetailedStats()">
                        üìà Show Detailed Statistics
                    </button>
                    <button class="btn btn-success" onclick="exportProgress()">
                        üíæ Save Progress Report
                    </button>
                    <button class="btn btn-secondary" onclick="resetProgress()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        üîÑ Reset Progress
                    </button>
                </div>

                <div id="detailedStats" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 10px;">
                    <!-- Detailed statistics will appear here -->
                </div>

                <div id="reportOutput" style="display: none; margin-top: 20px; background: white; padding: 20px; border-radius: 10px; border: 2px dashed #cbd5e1;">
                    <h4>üìã Report (Click to Copy)</h4>
                    <pre id="reportText" style="white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 8px; cursor: pointer;" onclick="copyReport()"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration - with error handling
        let db = null;
        let firebaseAvailable = false;
        
        // Try to initialize Firebase
        try {
            if (typeof firebase !== 'undefined') {
                const firebaseConfig = {
                    apiKey: "AIzaSyAs7_DlWthyuWVVLbYCo7SQHHt2Siw_DH0",
                    authDomain: "jordan-math-practice.firebaseapp.com",
                    projectId: "jordan-math-practice",
                    storageBucket: "jordan-math-practice.firebasestorage.app",
                    messagingSenderId: "1011552332362",
                    appId: "1:1011552332362:web:8bc57f83156212d63094b3"
                };

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseAvailable = true;
                console.log('Firebase initialized successfully');
            } else {
                console.log('Firebase not available - using local storage only');
            }
        } catch (error) {
            console.log('Firebase initialization error:', error);
            console.log('Continuing with local storage only');
        }
        
        const userId = 'jordan'; // Simple user ID for Jordan
        
        // Question banks for each topic
        const questions = {
            fractions: {
                generate: function() {
                    const types = ['add', 'subtract', 'multiply', 'word'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'add') {
                        const d1 = [2, 3, 4, 5, 6, 8][Math.floor(Math.random() * 6)];
                        const d2 = [2, 3, 4, 5, 6, 8][Math.floor(Math.random() * 6)];
                        const n1 = Math.floor(Math.random() * (d1 - 1)) + 1;
                        const n2 = Math.floor(Math.random() * (d2 - 1)) + 1;
                        
                        // Find common denominator
                        const lcm = (d1 * d2) / gcd(d1, d2);
                        const answer = (n1 * lcm / d1 + n2 * lcm / d2);
                        const answerSimplified = simplifyFraction(answer, lcm);
                        
                        return {
                            question: `What is ${n1}/${d1} + ${n2}/${d2}?`,
                            options: generateFractionOptions(answerSimplified),
                            correct: 0,
                            hint: `Make the denominators the same. ${d1} and ${d2} both go into ${lcm}`,
                            explanation: `Think of ${lcm} pieces. ${n1}/${d1} = ${n1 * lcm / d1}/${lcm} and ${n2}/${d2} = ${n2 * lcm / d2}/${lcm}. Together that's ${answer}/${lcm} = ${answerSimplified}`
                        };
                    } else if (type === 'subtract') {
                        const d1 = [2, 3, 4, 5, 6, 8][Math.floor(Math.random() * 6)];
                        const d2 = [2, 3, 4, 5, 6, 8][Math.floor(Math.random() * 6)];
                        let n1 = Math.floor(Math.random() * (d1 - 1)) + 1;
                        let n2 = Math.floor(Math.random() * (d2 - 1)) + 1;
                        
                        // Ensure positive result
                        const lcm = (d1 * d2) / gcd(d1, d2);
                        if (n1/d1 < n2/d2) {
                            [n1, n2, d1, d2] = [n2, n1, d2, d1];
                        }
                        
                        const answer = (n1 * lcm / d1 - n2 * lcm / d2);
                        const answerSimplified = simplifyFraction(answer, lcm);
                        
                        return {
                            question: `What is ${n1}/${d1} - ${n2}/${d2}?`,
                            options: generateFractionOptions(answerSimplified),
                            correct: 0,
                            hint: `First make denominators the same. Find a number both ${d1} and ${d2} go into`,
                            explanation: `Convert to ${lcm} pieces: ${n1}/${d1} = ${n1 * lcm / d1}/${lcm} and ${n2}/${d2} = ${n2 * lcm / d2}/${lcm}. Subtract: ${n1 * lcm / d1}/${lcm} - ${n2 * lcm / d2}/${lcm} = ${answerSimplified}`
                        };
                    } else if (type === 'multiply') {
                        const n1 = Math.floor(Math.random() * 4) + 1;
                        const d1 = Math.floor(Math.random() * 6) + 2;
                        const wholeNum = Math.floor(Math.random() * 5) + 2;
                        
                        const answerNum = n1 * wholeNum;
                        const answerSimplified = simplifyFraction(answerNum, d1);
                        
                        return {
                            question: `What is ${n1}/${d1} √ó ${wholeNum}?`,
                            options: generateFractionOptions(answerSimplified),
                            correct: 0,
                            hint: `Multiply the top number by ${wholeNum}, keep the bottom number the same`,
                            explanation: `${n1} √ó ${wholeNum} = ${answerNum}, so the answer is ${answerNum}/${d1} = ${answerSimplified}`
                        };
                    } else {
                        const total = (Math.floor(Math.random() * 4) + 2) * 12;
                        const fractionUsed = [1, 2, 3][Math.floor(Math.random() * 3)];
                        const denominator = [3, 4, 6][Math.floor(Math.random() * 3)];
                        const amountUsed = (total * fractionUsed) / denominator;
                        const remaining = total - amountUsed;
                        
                        return {
                            question: `A recipe needs ${total} cookies. You've made ${fractionUsed}/${denominator} of them. How many cookies are left to make?`,
                            answer: remaining,
                            hint: `First find how many cookies you made: ${fractionUsed}/${denominator} of ${total}`,
                            explanation: `${fractionUsed}/${denominator} of ${total} = ${total} √ó ${fractionUsed} √∑ ${denominator} = ${amountUsed} cookies made. Still need: ${total} - ${amountUsed} = ${remaining} cookies`
                        };
                    }
                }
            },
            operations: {
                generate: function() {
                    const types = ['multiply', 'divide', 'add', 'subtract'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'multiply') {
                        const num1 = Math.floor(Math.random() * 50) + 10;
                        const num2 = Math.floor(Math.random() * 9) + 2;
                        const answer = num1 * num2;
                        
                        return {
                            question: `What is ${num1} √ó ${num2}?`,
                            answer: answer,
                            hint: `Break it down: ${num1} √ó ${num2} = (${Math.floor(num1/10)*10} √ó ${num2}) + (${num1%10} √ó ${num2})`,
                            explanation: `${Math.floor(num1/10)*10} √ó ${num2} = ${Math.floor(num1/10)*10 * num2}, and ${num1%10} √ó ${num2} = ${(num1%10) * num2}. Add them: ${answer}`
                        };
                    } else if (type === 'divide') {
                        const divisor = Math.floor(Math.random() * 8) + 2;
                        const quotient = Math.floor(Math.random() * 50) + 10;
                        const dividend = divisor * quotient;
                        
                        return {
                            question: `Calculate: ${dividend} √∑ ${divisor}`,
                            answer: quotient,
                            hint: `Think: how many ${divisor}s fit into ${dividend}?`,
                            explanation: `${divisor} √ó ${quotient} = ${dividend}, so ${dividend} √∑ ${divisor} = ${quotient}`
                        };
                    } else if (type === 'add') {
                        const num1 = Math.floor(Math.random() * 500) + 100;
                        const num2 = Math.floor(Math.random() * 500) + 100;
                        const answer = num1 + num2;
                        
                        return {
                            question: `What is ${num1} + ${num2}?`,
                            answer: answer,
                            hint: `Add the hundreds, then tens, then ones`,
                            explanation: `${Math.floor(num1/100)*100} + ${Math.floor(num2/100)*100} = ${Math.floor(num1/100)*100 + Math.floor(num2/100)*100}, plus the rest gives ${answer}`
                        };
                    } else {
                        const num1 = Math.floor(Math.random() * 800) + 200;
                        const num2 = Math.floor(Math.random() * (num1 - 100)) + 50;
                        const answer = num1 - num2;
                        
                        return {
                            question: `Calculate: ${num1} - ${num2}`,
                            answer: answer,
                            hint: `You might need to borrow when subtracting`,
                            explanation: `${num1} - ${num2} = ${answer}. Check: ${answer} + ${num2} = ${num1} ‚úì`
                        };
                    }
                }
            },
            algebra: {
                generate: function() {
                    const types = ['solve', 'pattern', 'substitute'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'solve') {
                        const coefficient = Math.floor(Math.random() * 5) + 2;
                        const answer = Math.floor(Math.random() * 10) + 2;
                        const result = coefficient * answer;
                        
                        return {
                            question: `If ${coefficient}x = ${result}, what is x?`,
                            options: generateNumberOptions(answer),
                            correct: 0,
                            hint: `Divide both sides by ${coefficient}`,
                            explanation: `To get x alone, divide ${result} by ${coefficient}: x = ${result} √∑ ${coefficient} = ${answer}`
                        };
                    } else if (type === 'pattern') {
                        const start = Math.floor(Math.random() * 10) + 2;
                        const increment = Math.floor(Math.random() * 5) + 2;
                        const seq = [start, start + increment, start + 2*increment, start + 3*increment];
                        const next = start + 4*increment;
                        
                        return {
                            question: `What comes next in the pattern: ${seq.join(', ')}, ...?`,
                            options: generateNumberOptions(next),
                            correct: 0,
                            hint: `Find what's being added each time`,
                            explanation: `Each number increases by ${increment}. So ${seq[3]} + ${increment} = ${next}`
                        };
                    } else {
                        const x = Math.floor(Math.random() * 8) + 2;
                        const multiplier = Math.floor(Math.random() * 4) + 2;
                        const adder = Math.floor(Math.random() * 10) + 1;
                        const answer = multiplier * x + adder;
                        
                        return {
                            question: `If x = ${x}, what is ${multiplier}x + ${adder}?`,
                            options: generateNumberOptions(answer),
                            correct: 0,
                            hint: `Replace x with ${x}, then calculate`,
                            explanation: `Put ${x} where x is: ${multiplier}(${x}) + ${adder} = ${multiplier * x} + ${adder} = ${answer}`
                        };
                    }
                }
            },
            'word-problems': {
                generate: function() {
                    const types = ['speed', 'proportion', 'percentage', 'time'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'speed') {
                        const speed = Math.floor(Math.random() * 30) * 5 + 30;
                        const time = Math.floor(Math.random() * 4) + 2;
                        const distance = speed * time;
                        
                        return {
                            question: `A car travels ${speed} miles per hour. How far does it go in ${time} hours?`,
                            answer: distance,
                            hint: `Distance = Speed √ó Time`,
                            explanation: `Multiply: ${speed} miles/hour √ó ${time} hours = ${distance} miles`,
                            steps: [
                                `Identify: Speed = ${speed} mph, Time = ${time} hours`,
                                `Formula: Distance = Speed √ó Time`,
                                `Calculate: ${speed} √ó ${time} = ${distance}`,
                                `Answer: ${distance} miles`
                            ]
                        };
                    } else if (type === 'proportion') {
                        const perItem = Math.floor(Math.random() * 15) + 5;
                        const days = Math.floor(Math.random() * 12) + 3;
                        const total = perItem * days;
                        
                        return {
                            question: `Jordan reads ${perItem} pages every day. How many pages will he read in ${days} days?`,
                            answer: total,
                            hint: `Multiply pages per day by number of days`,
                            explanation: `${perItem} pages/day √ó ${days} days = ${total} pages`,
                            steps: [
                                `Daily reading: ${perItem} pages`,
                                `Number of days: ${days}`,
                                `Total: ${perItem} √ó ${days} = ${total} pages`
                            ]
                        };
                    } else if (type === 'percentage') {
                        const whole = Math.floor(Math.random() * 20) * 10 + 40;
                        const percentages = [10, 20, 25, 50];
                        const percent = percentages[Math.floor(Math.random() * percentages.length)];
                        const part = (whole * percent) / 100;
                        const remaining = whole - part;
                        
                        return {
                            question: `A store has ${whole} items. They sold ${percent}% of them. How many items are left?`,
                            answer: remaining,
                            hint: `First find ${percent}% of ${whole}, then subtract`,
                            explanation: `${percent}% of ${whole} = ${part}. Items left: ${whole} - ${part} = ${remaining}`,
                            steps: [
                                `Total items: ${whole}`,
                                `Sold: ${percent}% of ${whole} = ${part}`,
                                `Remaining: ${whole} - ${part} = ${remaining}`
                            ]
                        };
                    } else {
                        const hours = Math.floor(Math.random() * 3) + 1;
                        const minutes = Math.floor(Math.random() * 4) * 15;
                        const totalMinutes = hours * 60 + minutes;
                        
                        return {
                            question: `A movie is ${hours} hour${hours > 1 ? 's' : ''} and ${minutes} minutes long. How many minutes is that in total?`,
                            answer: totalMinutes,
                            hint: `Convert hours to minutes first (1 hour = 60 minutes)`,
                            explanation: `${hours} hour${hours > 1 ? 's' : ''} = ${hours * 60} minutes. Add ${minutes} minutes = ${totalMinutes} minutes total`,
                            steps: [
                                `Convert hours: ${hours} √ó 60 = ${hours * 60} minutes`,
                                `Add remaining minutes: ${hours * 60} + ${minutes}`,
                                `Total: ${totalMinutes} minutes`
                            ]
                        };
                    }
                }
            },
            geometry: {
                generate: function() {
                    const types = ['volume', 'area', 'perimeter', 'angles'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'volume') {
                        const length = Math.floor(Math.random() * 5) + 2;
                        const width = Math.floor(Math.random() * 5) + 2;
                        const height = Math.floor(Math.random() * 5) + 2;
                        const volume = length * width * height;
                        
                        return {
                            question: `A box has length ${length}, width ${width}, and height ${height}. What is its volume?`,
                            answer: volume,
                            hint: `Volume = length √ó width √ó height`,
                            explanation: `Multiply all three: ${length} √ó ${width} √ó ${height} = ${volume} cubic units`
                        };
                    } else if (type === 'area') {
                        const length = Math.floor(Math.random() * 10) + 5;
                        const width = Math.floor(Math.random() * 10) + 3;
                        const area = length * width;
                        
                        return {
                            question: `A rectangle has length ${length} and width ${width}. What is its area?`,
                            answer: area,
                            hint: `Area = length √ó width`,
                            explanation: `${length} √ó ${width} = ${area} square units`
                        };
                    } else if (type === 'perimeter') {
                        const side = Math.floor(Math.random() * 8) + 3;
                        const perimeter = side * 4;
                        
                        return {
                            question: `A square has sides of length ${side}. What is its perimeter?`,
                            answer: perimeter,
                            hint: `A square has 4 equal sides`,
                            explanation: `Add all 4 sides: ${side} + ${side} + ${side} + ${side} = ${perimeter} units`
                        };
                    } else {
                        const angle1 = Math.floor(Math.random() * 40) + 30;
                        const angle2 = Math.floor(Math.random() * 40) + 40;
                        const angle3 = 180 - angle1 - angle2;
                        
                        return {
                            question: `A triangle has angles of ${angle1}¬∞ and ${angle2}¬∞. What is the third angle?`,
                            answer: angle3,
                            hint: `Triangle angles add up to 180¬∞`,
                            explanation: `180¬∞ - ${angle1}¬∞ - ${angle2}¬∞ = ${angle3}¬∞`
                        };
                    }
                }
            },
            measurement: {
                generate: function() {
                    const types = ['time', 'length', 'convert'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'time') {
                        const hours = Math.floor(Math.random() * 12) + 1;
                        const minutes = Math.floor(Math.random() * 4) * 15;
                        const addHours = Math.floor(Math.random() * 3) + 1;
                        const addMinutes = [15, 30, 45][Math.floor(Math.random() * 3)];
                        
                        let endHour = hours + addHours;
                        let endMinute = minutes + addMinutes;
                        if (endMinute >= 60) {
                            endHour += 1;
                            endMinute -= 60;
                        }
                        if (endHour > 12) endHour -= 12;
                        
                        const startTime = `${hours}:${minutes.toString().padStart(2, '0')}`;
                        const endTime = `${endHour}:${endMinute.toString().padStart(2, '0')}`;
                        
                        return {
                            question: `If it's ${startTime}, what time will it be in ${addHours} hour${addHours > 1 ? 's' : ''} and ${addMinutes} minutes?`,
                            options: generateTimeOptions(endTime),
                            correct: 0,
                            hint: `Add the hours first, then add the minutes`,
                            explanation: `${startTime} + ${addHours} hour${addHours > 1 ? 's' : ''} = ${hours + addHours}:${minutes.toString().padStart(2, '0')}, then add ${addMinutes} minutes = ${endTime}`
                        };
                    } else if (type === 'length') {
                        const feet = Math.floor(Math.random() * 8) + 2;
                        const inches = feet * 12;
                        
                        return {
                            question: `How many inches are in ${feet} feet?`,
                            options: generateNumberOptions(inches),
                            correct: 0,
                            hint: `1 foot = 12 inches`,
                            explanation: `${feet} feet √ó 12 inches/foot = ${inches} inches`
                        };
                    } else {
                        const yards = Math.floor(Math.random() * 3) + 2;
                        const feet = yards * 3;
                        
                        return {
                            question: `Convert ${yards} yards to feet`,
                            options: generateNumberOptions(feet),
                            correct: 0,
                            hint: `1 yard = 3 feet`,
                            explanation: `${yards} yards √ó 3 feet/yard = ${feet} feet`
                        };
                    }
                }
            },
            ratios: {
                generate: function() {
                    const types = ['basic', 'recipe', 'speed', 'scale'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'basic') {
                        const ratio1 = Math.floor(Math.random() * 4) + 2;
                        const ratio2 = Math.floor(Math.random() * 4) + 2;
                        const multiplier = Math.floor(Math.random() * 3) + 2;
                        const given = ratio1 * multiplier;
                        const answer = ratio2 * multiplier;
                        
                        return {
                            question: `The ratio of red to blue marbles is ${ratio1}:${ratio2}. If there are ${given} red marbles, how many blue marbles are there?`,
                            answer: answer,
                            hint: `${given} red is ${multiplier} times ${ratio1}`,
                            explanation: `${given} √∑ ${ratio1} = ${multiplier} groups. Each group has ${ratio2} blue, so ${multiplier} √ó ${ratio2} = ${answer} blue marbles`,
                            steps: [
                                `Ratio: ${ratio1} red : ${ratio2} blue`,
                                `Groups: ${given} √∑ ${ratio1} = ${multiplier}`,
                                `Blue marbles: ${multiplier} √ó ${ratio2} = ${answer}`
                            ]
                        };
                    } else if (type === 'recipe') {
                        const flour = Math.floor(Math.random() * 3) + 2;
                        const sugar = Math.floor(Math.random() * 3) + 3;
                        const multiplier = Math.floor(Math.random() * 3) + 2;
                        const newFlour = flour * multiplier;
                        const newSugar = sugar * multiplier;
                        
                        return {
                            question: `A recipe uses ${flour} cups flour for every ${sugar} cups sugar. If you use ${newFlour} cups flour, how many cups of sugar do you need?`,
                            answer: newSugar,
                            hint: `${newFlour} is ${multiplier} times ${flour}`,
                            explanation: `Flour increased ${multiplier} times (${flour} to ${newFlour}), so sugar must too: ${sugar} √ó ${multiplier} = ${newSugar}`,
                            steps: [
                                `Original: ${flour} flour : ${sugar} sugar`,
                                `Scale: ${newFlour} √∑ ${flour} = ${multiplier}`,
                                `Sugar needed: ${sugar} √ó ${multiplier} = ${newSugar}`
                            ]
                        };
                    } else if (type === 'speed') {
                        const distance = Math.floor(Math.random() * 50) * 10 + 100;
                        const time = Math.floor(Math.random() * 4) + 2;
                        const speed = distance / time;
                        
                        return {
                            question: `A train travels ${distance} miles in ${time} hours. What is its speed in miles per hour?`,
                            answer: speed,
                            hint: `Speed = distance √∑ time`,
                            explanation: `${distance} miles √∑ ${time} hours = ${speed} mph`,
                            steps: [
                                `Distance: ${distance} miles`,
                                `Time: ${time} hours`,
                                `Speed: ${distance} √∑ ${time} = ${speed} mph`
                            ]
                        };
                    } else {
                        const items = Math.floor(Math.random() * 4) + 2;
                        const price = (Math.floor(Math.random() * 10) + 5) * items;
                        const wantItems = Math.floor(Math.random() * 5) + items + 1;
                        const unitPrice = price / items;
                        const totalCost = unitPrice * wantItems;
                        
                        return {
                            question: `If ${items} pencils cost ${price}, how much do ${wantItems} pencils cost?`,
                            answer: totalCost,
                            hint: `Find the cost of 1 pencil first`,
                            explanation: `1 pencil costs ${price}√∑${items} = ${unitPrice}. So ${wantItems} pencils cost ${unitPrice} √ó ${wantItems} = ${totalCost}`,
                            steps: [
                                `Cost of ${items} pencils: ${price}`,
                                `Cost of 1 pencil: ${price} √∑ ${items} = ${unitPrice}`,
                                `Cost of ${wantItems} pencils: ${unitPrice} √ó ${wantItems} = ${totalCost}`
                            ]
                        };
                    }
                }
            },
            integers: {
                generate: function() {
                    const types = ['add', 'subtract', 'multiply', 'temperature', 'depth'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'add') {
                        const num1 = Math.floor(Math.random() * 20) - 10;
                        const num2 = Math.floor(Math.random() * 20) - 10;
                        const answer = num1 + num2;
                        
                        return {
                            question: `What is ${num1} + (${num2})?`,
                            answer: answer,
                            hint: num2 < 0 ? `Adding negative is like subtracting` : `Use a number line`,
                            explanation: `${num1} + (${num2}) = ${answer}. Think: start at ${num1}, move ${Math.abs(num2)} ${num2 < 0 ? 'left' : 'right'}`
                        };
                    } else if (type === 'subtract') {
                        const num1 = Math.floor(Math.random() * 20) - 10;
                        const num2 = Math.floor(Math.random() * 20) - 10;
                        const answer = num1 - num2;
                        
                        return {
                            question: `Calculate: ${num1} - (${num2})`,
                            answer: answer,
                            hint: num2 < 0 ? `Subtracting negative = adding` : `Move left on number line`,
                            explanation: `${num1} - (${num2}) = ${answer}. ${num2 < 0 ? 'Two negatives make positive!' : 'Subtract normally'}`
                        };
                    } else if (type === 'multiply') {
                        const num1 = Math.floor(Math.random() * 8) - 4;
                        const num2 = Math.floor(Math.random() * 8) + 1;
                        const answer = num1 * num2;
                        
                        return {
                            question: `What is ${num1} √ó ${num2}?`,
                            answer: answer,
                            hint: num1 < 0 ? `Negative √ó positive = negative` : `Multiply normally`,
                            explanation: `${num1} √ó ${num2} = ${answer}. ${num1 < 0 ? 'Negative times positive gives negative' : 'Both positive, answer is positive'}`
                        };
                    } else if (type === 'temperature') {
                        const start = Math.floor(Math.random() * 10) - 5;
                        const change = Math.floor(Math.random() * 15) + 5;
                        const goingUp = Math.random() > 0.5;
                        const end = goingUp ? start + change : start - change;
                        
                        return {
                            question: `Temperature was ${start}¬∞C. It ${goingUp ? 'rose' : 'dropped'} ${change} degrees. What's the new temperature?`,
                            answer: end,
                            hint: goingUp ? `Add to current temp` : `Subtract from current temp`,
                            explanation: `${start}¬∞C ${goingUp ? '+' : '-'} ${change}¬∞ = ${end}¬∞C`
                        };
                    } else {
                        const start = Math.floor(Math.random() * 300) - 500;
                        const change = Math.floor(Math.random() * 200) + 50;
                        const goingUp = Math.random() > 0.5;
                        const end = goingUp ? start + change : start - change;
                        
                        return {
                            question: `A submarine is at ${start} feet. It ${goingUp ? 'rises' : 'descends'} ${change} feet. What's the new depth?`,
                            answer: end,
                            hint: `Negative means below sea level`,
                            explanation: `${start} ${goingUp ? '+' : '-'} ${change} = ${end} feet`
                        };
                    }
                }
            },
            expressions: {
                generate: function() {
                    const types = ['simplify', 'evaluate', 'distribute', 'translate'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    
                    if (type === 'simplify') {
                        const coef1 = Math.floor(Math.random() * 5) + 1;
                        const coef2 = Math.floor(Math.random() * 5) + 1;
                        const sum = coef1 + coef2;
                        
                        return {
                            question: `Simplify: ${coef1}x + ${coef2}x`,
                            options: [`${sum}x`, `${coef1 * coef2}x`, `${sum}`, `${coef1}x${coef2}`],
                            correct: 0,
                            hint: `Add the numbers in front of x`,
                            explanation: `Think: ${coef1} apples + ${coef2} apples = ${sum} apples. So ${coef1}x + ${coef2}x = ${sum}x`
                        };
                    } else if (type === 'evaluate') {
                        const x = Math.floor(Math.random() * 6) + 2;
                        const multiplier = Math.floor(Math.random() * 4) + 2;
                        const adder = Math.floor(Math.random() * 10) + 3;
                        const answer = multiplier * x + adder;
                        
                        return {
                            question: `If x = ${x}, what is ${multiplier}x + ${adder}?`,
                            options: generateNumberOptions(answer),
                            correct: 0,
                            hint: `Replace x with ${x}`,
                            explanation: `Put ${x} where x is: ${multiplier}(${x}) + ${adder} = ${multiplier * x} + ${adder} = ${answer}`
                        };
                    } else if (type === 'distribute') {
                        const outside = Math.floor(Math.random() * 4) + 2;
                        const inside = Math.floor(Math.random() * 5) + 2;
                        const distributed = outside * inside;
                        
                        return {
                            question: `Simplify: ${outside}(x + ${inside})`,
                            options: [`${outside}x + ${distributed}`, `${outside}x + ${inside}`, `x + ${distributed}`, `${outside + inside}x`],
                            correct: 0,
                            hint: `Multiply ${outside} by everything inside`,
                            explanation: `Give ${outside} to both: ${outside}√óx = ${outside}x and ${outside}√ó${inside} = ${distributed}. Answer: ${outside}x + ${distributed}`,
                            steps: [
                                `Distribute ${outside} to x: ${outside}x`,
                                `Distribute ${outside} to ${inside}: ${distributed}`,
                                `Result: ${outside}x + ${distributed}`
                            ]
                        };
                    } else {
                        const coefficient = Math.floor(Math.random() * 4) + 2;
                        const constant = Math.floor(Math.random() * 10) + 3;
                        
                        return {
                            question: `Write as an expression: "${constant} more than ${coefficient} times a number n"`,
                            options: [`${coefficient}n + ${constant}`, `${constant}n + ${coefficient}`, `n + ${coefficient + constant}`, `${coefficient + constant}n`],
                            correct: 0,
                            hint: `"${coefficient} times n" then "add ${constant}"`,
                            explanation: `${coefficient} times n = ${coefficient}n. Then ${constant} more = ${coefficient}n + ${constant}`
                        };
                    }
                }
            }
        };

        // Helper functions for generating questions
        function gcd(a, b) {
            return b === 0 ? a : gcd(b, a % b);
        }

        function simplifyFraction(num, den) {
            const divisor = gcd(num, den);
            return `${num/divisor}/${den/divisor}`;
        }

        function generateFractionOptions(correct) {
            const options = [correct];
            // Generate 3 plausible wrong answers
            const parts = correct.split('/');
            if (parts.length === 2) {
                const n = parseInt(parts[0]);
                const d = parseInt(parts[1]);
                options.push(`${n+1}/${d}`);
                options.push(`${n}/${d+1}`);
                options.push(`${Math.max(1, n-1)}/${d}`);
            } else {
                options.push(`${parseInt(correct) + 1}`);
                options.push(`${parseInt(correct) - 1}`);
                options.push(`${parseInt(correct) + 2}`);
            }
            return shuffleArray(options);
        }

        function generateNumberOptions(correct) {
            const options = [correct];
            options.push(correct + Math.floor(Math.random() * 5) + 1);
            options.push(Math.max(1, correct - Math.floor(Math.random() * 5) - 1));
            options.push(correct + Math.floor(Math.random() * 10) + 5);
            return shuffleArray(options);
        }

        function generateTimeOptions(correct) {
            const options = [correct];
            // Generate plausible wrong times
            const parts = correct.split(':');
            const hour = parseInt(parts[0]);
            const minute = parseInt(parts[1]);
            
            options.push(`${hour}:${((minute + 15) % 60).toString().padStart(2, '0')}`);
            options.push(`${hour + 1}:${minute.toString().padStart(2, '0')}`);
            options.push(`${Math.max(1, hour - 1)}:${minute.toString().padStart(2, '0')}`);
            
            return shuffleArray(options);
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        let currentTopic = null;
        let currentQuestionIndex = 0;
        let completedProblems = 0;
        let totalAttempts = 0;
        let correctCount = 0;
        let startTime = Date.now();
        let topicStats = {
            fractions: { attempted: 0, correct: 0 },
            operations: { attempted: 0, correct: 0 },
            algebra: { attempted: 0, correct: 0 },
            'word-problems': { attempted: 0, correct: 0 },
            geometry: { attempted: 0, correct: 0 },
            measurement: { attempted: 0, correct: 0 },
            ratios: { attempted: 0, correct: 0 },
            integers: { attempted: 0, correct: 0 },
            expressions: { attempted: 0, correct: 0 }
        };
        let problemHistory = [];

        function selectTopic(topic) {
            // Hide all practice areas
            document.querySelectorAll('.practice-area').forEach(area => {
                area.classList.remove('active');
            });
            
            // Remove active class from all cards
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Show selected practice area
            document.getElementById(`${topic}-practice`).classList.add('active');
            
            // Add active class to selected card
            event.currentTarget.classList.add('active');
            
            // Set current topic and load first question
            currentTopic = topic;
            currentQuestionIndex = 0;
            loadQuestion(topic);
        }

        function loadQuestion(topic) {
            // Generate a new question for this topic
            const question = questions[topic].generate();
            
            // Store current question for checking answers
            window.currentQuestion = question;
            
            // Clear previous feedback
            const feedback = document.getElementById(`${topic}-feedback`);
            if (feedback) {
                feedback.style.display = 'none';
                feedback.className = 'feedback-message';
            }
            
            // Hide hint
            document.getElementById(`${topic}-hint`).classList.remove('show');
            
            // Load question
            document.getElementById(`${topic}-question`).innerHTML = question.question;
            
            // Set hint text
            document.getElementById(`${topic}-hint-text`).textContent = question.hint;
            
            // Load answers based on type
            if (question.options) {
                // Multiple choice
                const answersDiv = document.getElementById(`${topic}-answers`);
                if (answersDiv) {
                    answersDiv.innerHTML = '';
                    question.options.forEach((option, index) => {
                        const btn = document.createElement('button');
                        btn.className = 'answer-btn';
                        btn.textContent = option;
                        btn.onclick = () => checkMultipleChoice(topic, index);
                        answersDiv.appendChild(btn);
                    });
                }
            } else {
                // Text input
                const input = document.getElementById(`${topic}-answer`);
                if (input) {
                    input.value = '';
                    input.focus();
                }
            }
            
            // Hide step explanation if it exists
            const steps = document.getElementById(`${topic}-steps`);
            if (steps) {
                steps.style.display = 'none';
            }
        }

        function checkMultipleChoice(topic, selectedIndex) {
            const question = questions[topic][currentQuestionIndex];
            const buttons = document.querySelectorAll(`#${topic}-answers .answer-btn`);
            const feedback = document.getElementById(`${topic}-feedback`);
            
            totalAttempts++;
            topicStats[topic].attempted++;
            
            const isCorrect = selectedIndex === question.correct;
            
            // Track problem in history
            problemHistory.push({
                topic: topic,
                question: question.question,
                userAnswer: question.options[selectedIndex],
                correctAnswer: question.options[question.correct],
                isCorrect: isCorrect,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (isCorrect) {
                buttons[selectedIndex].classList.add('correct');
                feedback.className = 'feedback-message correct';
                feedback.innerHTML = `‚úÖ Correct! ${question.explanation}`;
                feedback.style.display = 'block';
                completedProblems++;
                correctCount++;
                topicStats[topic].correct++;
                updateProgress();
            } else {
                buttons[selectedIndex].classList.add('incorrect');
                buttons[question.correct].classList.add('correct');
                feedback.className = 'feedback-message incorrect';
                feedback.innerHTML = `‚ùå Not quite. The correct answer is ${question.options[question.correct]}. ${question.explanation}`;
                feedback.style.display = 'block';
            }
            
            // Disable all buttons after answering
            buttons.forEach(btn => btn.disabled = true);
            updateParentDashboard();
        }

        function checkAnswer(topic) {
            const input = document.getElementById(`${topic}-answer`);
            const userAnswer = topic === 'integers' ? parseInt(input.value) : parseFloat(input.value);
            const question = questions[topic][currentQuestionIndex];
            const feedback = document.getElementById(`${topic}-feedback`);
            
            totalAttempts++;
            topicStats[topic].attempted++;
            
            const isCorrect = userAnswer === question.answer;
            
            // Track problem in history
            problemHistory.push({
                topic: topic,
                question: question.question,
                userAnswer: userAnswer,
                correctAnswer: question.answer,
                isCorrect: isCorrect,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (isCorrect) {
                feedback.className = 'feedback-message correct';
                feedback.innerHTML = `‚úÖ Correct! ${question.explanation}`;
                feedback.style.display = 'block';
                completedProblems++;
                correctCount++;
                topicStats[topic].correct++;
                updateProgress();
                
                // Show steps if available
                if (question.steps) {
                    showSteps(topic, question.steps);
                }
            } else {
                feedback.className = 'feedback-message incorrect';
                feedback.innerHTML = `‚ùå Not quite. The correct answer is ${question.answer}. ${question.explanation}`;
                feedback.style.display = 'block';
                
                // Show steps even when incorrect
                if (question.steps) {
                    showSteps(topic, question.steps);
                }
            }
            
            updateParentDashboard();
        }

        function showSteps(topic, steps) {
            const stepsDiv = document.getElementById(`${topic}-steps`);
            if (stepsDiv) {
                stepsDiv.innerHTML = '<h4>Step-by-Step Solution:</h4>';
                steps.forEach((step, index) => {
                    stepsDiv.innerHTML += `<div class="step" data-step="${index + 1}">${step}</div>`;
                });
                stepsDiv.style.display = 'block';
            }
        }

        function showHint(topic) {
            document.getElementById(`${topic}-hint`).classList.add('show');
        }

        function nextQuestion(topic) {
            const questionBank = questions[topic];
            currentQuestionIndex = (currentQuestionIndex + 1) % questionBank.length;
            loadQuestion(topic);
        }

        function updateProgress() {
            document.getElementById('completedCount').textContent = completedProblems;
            const percentage = Math.min((completedProblems / 10) * 100, 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            // Update projected level
            updateProjectedLevel();
            
            if (completedProblems >= 10 && completedProblems % 10 === 0) {
                alert('üéâ Great job! You reached your goal of 10 problems!');
            }
        }

        function updateProjectedLevel() {
            const baseLevel = 460;
            let levelBoost = 0;
            
            // Calculate boost based on different factors
            
            // 1. Problems completed (up to +20 points)
            levelBoost += Math.min(completedProblems * 0.5, 20);
            
            // 2. Overall accuracy bonus (up to +30 points)
            const overallAccuracy = totalAttempts > 0 ? (correctCount / totalAttempts) : 0;
            if (overallAccuracy >= 0.9) levelBoost += 30;
            else if (overallAccuracy >= 0.8) levelBoost += 20;
            else if (overallAccuracy >= 0.7) levelBoost += 10;
            else if (overallAccuracy >= 0.6) levelBoost += 5;
            
            // 3. Topic mastery bonus (up to +50 points)
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted >= 3) {
                    const accuracy = stats.correct / stats.attempted;
                    if (accuracy >= 0.8) {
                        // Foundation topics worth 4 points each
                        if (['fractions', 'operations', 'algebra', 'geometry', 'measurement', 'word-problems'].includes(topic)) {
                            levelBoost += 4;
                        }
                        // Grade 6 topics worth 8 points each (harder content)
                        if (['ratios', 'integers', 'expressions'].includes(topic)) {
                            levelBoost += 8;
                        }
                    }
                }
            });
            
            // 4. Consistency bonus (up to +10 points)
            if (completedProblems >= 10 && overallAccuracy >= 0.7) {
                levelBoost += 10;
            }
            
            // 5. Challenge bonus for attempting Grade 6 content (+5 per topic tried)
            ['ratios', 'integers', 'expressions'].forEach(topic => {
                if (topicStats[topic].attempted > 0) {
                    levelBoost += 5;
                }
            });
            
            // Calculate and display projected level
            const projectedLevel = Math.min(baseLevel + Math.round(levelBoost), 650);
            const projectedElement = document.getElementById('projectedLevel');
            projectedElement.textContent = projectedLevel;
            
            // Color code based on improvement
            if (projectedLevel >= 600) {
                projectedElement.style.color = '#10b981'; // Green - at target!
                projectedElement.innerHTML = projectedLevel + ' üéØ';
            } else if (projectedLevel >= 550) {
                projectedElement.style.color = '#f59e0b'; // Orange - getting close
                projectedElement.innerHTML = projectedLevel + ' üìà';
            } else if (projectedLevel >= 500) {
                projectedElement.style.color = '#3b82f6'; // Blue - good progress
                projectedElement.innerHTML = projectedLevel + ' ‚¨ÜÔ∏è';
            } else {
                projectedElement.style.color = '#8b5cf6'; // Purple - starting out
            }
            
            // Save progress to localStorage for persistence
            saveProgressToLocal();
        }

        function saveProgressToLocal() {
            const progressData = {
                completedProblems: completedProblems,
                totalAttempts: totalAttempts,
                correctCount: correctCount,
                topicStats: topicStats,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to Firebase
            saveToFirebase(progressData);
            
            // Also save locally as backup
            try {
                localStorage.setItem('jordanMathProgress', JSON.stringify(progressData));
            } catch(e) {
                console.log('LocalStorage not available');
            }
        }

        function saveToFirebase(data) {
            if (!firebaseAvailable || !db) {
                console.log('Firebase not available - saving locally only');
                return;
            }
            
            // Add timestamp and calculate projected level
            const projectedLevel = calculateProjectedLevel();
            const firebaseData = {
                ...data,
                projectedLevel: projectedLevel,
                timestamp: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            
            // Save to Firestore
            db.collection('users').doc(userId).set(firebaseData, { merge: true })
                .then(() => {
                    console.log('Progress saved to cloud');
                })
                .catch(error => {
                    console.error('Error saving to Firebase:', error);
                });
        }

        function loadProgressFromFirebase() {
            if (!firebaseAvailable || !db) {
                console.log('Firebase not available - loading from local storage');
                loadProgressFromLocal();
                return;
            }
            
            db.collection('users').doc(userId).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Load progress from Firebase
                        completedProblems = data.completedProblems || 0;
                        totalAttempts = data.totalAttempts || 0;
                        correctCount = data.correctCount || 0;
                        topicStats = data.topicStats || topicStats;
                        
                        // Update UI
                        updateProgress();
                        updateParentDashboard();
                        
                        // Show sync status
                        showSyncStatus('‚úÖ Progress loaded from cloud');
                    } else {
                        // No saved data yet
                        console.log('No previous progress found');
                        showSyncStatus('üÜï Starting fresh');
                    }
                })
                .catch(error => {
                    console.error('Error loading from Firebase:', error);
                    // Try to load from localStorage as fallback
                    loadProgressFromLocal();
                    showSyncStatus('‚ö†Ô∏è Offline mode - using local data');
                });
        }

        function showSyncStatus(message) {
            // Create or update sync status indicator
            let statusDiv = document.getElementById('syncStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'syncStatus';
                statusDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; z-index: 1000; animation: fadeIn 0.5s;';
                document.body.appendChild(statusDiv);
            }
            statusDiv.textContent = message;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }, 3000);
        }

        function calculateProjectedLevel() {
            const baseLevel = 460;
            let levelBoost = 0;
            
            // Calculate boost based on different factors
            levelBoost += Math.min(completedProblems * 0.5, 20);
            
            const overallAccuracy = totalAttempts > 0 ? (correctCount / totalAttempts) : 0;
            if (overallAccuracy >= 0.9) levelBoost += 30;
            else if (overallAccuracy >= 0.8) levelBoost += 20;
            else if (overallAccuracy >= 0.7) levelBoost += 10;
            else if (overallAccuracy >= 0.6) levelBoost += 5;
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted >= 3) {
                    const accuracy = stats.correct / stats.attempted;
                    if (accuracy >= 0.8) {
                        if (['fractions', 'operations', 'algebra', 'geometry', 'measurement', 'word-problems'].includes(topic)) {
                            levelBoost += 4;
                        }
                        if (['ratios', 'integers', 'expressions'].includes(topic)) {
                            levelBoost += 8;
                        }
                    }
                }
            });
            
            if (completedProblems >= 10 && overallAccuracy >= 0.7) {
                levelBoost += 10;
            }
            
            ['ratios', 'integers', 'expressions'].forEach(topic => {
                if (topicStats[topic].attempted > 0) {
                    levelBoost += 5;
                }
            });
            
            return Math.min(baseLevel + Math.round(levelBoost), 650);
        }

        function loadProgressFromLocal() {
            try {
                const saved = localStorage.getItem('jordanMathProgress');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Only load if from same day
                    const savedDate = new Date(data.lastUpdated).toDateString();
                    const today = new Date().toDateString();
                    if (savedDate === today) {
                        completedProblems = data.completedProblems || 0;
                        totalAttempts = data.totalAttempts || 0;
                        correctCount = data.correctCount || 0;
                        topicStats = data.topicStats || topicStats;
                        updateProgress();
                        updateParentDashboard();
                    }
                }
            } catch(e) {
                // localStorage might not be available
            }
        }

        function updateParentDashboard() {
            // Update basic stats
            document.getElementById('totalAttempted').textContent = totalAttempts;
            document.getElementById('correctAnswers').textContent = correctCount;
            
            // Calculate and update accuracy
            const accuracy = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
            
            // Update time spent
            const timeElapsed = Math.floor((Date.now() - startTime) / 60000);
            document.getElementById('timeSpent').textContent = timeElapsed + 'm';
            
            // Update topic performance
            updateTopicPerformance();
            
            // Identify areas needing attention
            identifyStrugglingAreas();
        }

        function updateTopicPerformance() {
            const container = document.getElementById('topicPerformance');
            container.innerHTML = '';
            
            const topicNames = {
                'fractions': 'ü•ß Fractions',
                'operations': '‚ûï Operations',
                'algebra': 'üî§ Algebra',
                'word-problems': 'üìñ Word Problems',
                'geometry': 'üìê Geometry',
                'measurement': 'üìè Measurement',
                'ratios': '‚öñÔ∏è Ratios (Grade 6)',
                'integers': '‚ûñ Negative Numbers (Grade 6)',
                'expressions': 'üìù Expressions (Grade 6)'
            };
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted > 0) {
                    const accuracy = Math.round((stats.correct / stats.attempted) * 100);
                    const barColor = accuracy >= 80 ? '#10b981' : accuracy >= 60 ? '#f59e0b' : '#ef4444';
                    
                    const topicDiv = document.createElement('div');
                    topicDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span style="font-weight: 600;">${topicNames[topic]}</span>
                            <span style="color: #666;">${stats.correct}/${stats.attempted} (${accuracy}%)</span>
                        </div>
                        <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="width: ${accuracy}%; background: ${barColor}; height: 100%; transition: width 0.5s ease;"></div>
                        </div>
                    `;
                    container.appendChild(topicDiv);
                }
            });
        }

        function identifyStrugglingAreas() {
            const container = document.getElementById('needsAttention');
            const strugglingTopics = [];
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted >= 2) {
                    const accuracy = (stats.correct / stats.attempted) * 100;
                    if (accuracy < 60) {
                        strugglingTopics.push({
                            topic: topic,
                            accuracy: Math.round(accuracy)
                        });
                    }
                }
            });
            
            if (strugglingTopics.length === 0) {
                container.innerHTML = '<span style="color: #10b981;">‚úÖ Great job! No areas of concern yet.</span>';
            } else {
                container.innerHTML = '<ul style="margin: 0; padding-left: 20px;">';
                strugglingTopics.forEach(item => {
                    const topicName = item.topic.charAt(0).toUpperCase() + item.topic.slice(1).replace('-', ' ');
                    container.innerHTML += `<li>${topicName} - Only ${item.accuracy}% correct. Needs more practice!</li>`;
                });
                container.innerHTML += '</ul>';
            }
        }

        function generateParentReport() {
            const accuracy = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
            const timeElapsed = Math.floor((Date.now() - startTime) / 60000);
            const date = new Date().toLocaleDateString();
            
            let report = `Jordan's Math Practice Report - ${date}\n`;
            report += `${'='.repeat(50)}\n\n`;
            
            report += `OVERALL PERFORMANCE\n`;
            report += `-------------------\n`;
            report += `Total Problems Attempted: ${totalAttempts}\n`;
            report += `Correct Answers: ${correctCount}\n`;
            report += `Accuracy Rate: ${accuracy}%\n`;
            report += `Time Spent: ${timeElapsed} minutes\n`;
            report += `Current IXL Level: 460\n`;
            report += `Projected Level: ${document.getElementById('projectedLevel').textContent}\n`;
            report += `Target Level: 600+\n\n`;
            
            report += `PERFORMANCE BY TOPIC\n`;
            report += `--------------------\n`;
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted > 0) {
                    const topicName = topic.charAt(0).toUpperCase() + topic.slice(1).replace('-', ' ');
                    const acc = Math.round((stats.correct / stats.attempted) * 100);
                    report += `${topicName}: ${stats.correct}/${stats.attempted} (${acc}%)\n`;
                }
            });
            
            // Identify strengths and weaknesses
            const strengths = [];
            const needsWork = [];
            
            Object.keys(topicStats).forEach(topic => {
                const stats = topicStats[topic];
                if (stats.attempted >= 2) {
                    const acc = (stats.correct / stats.attempted) * 100;
                    const topicName = topic.charAt(0).toUpperCase() + topic.slice(1).replace('-', ' ');
                    if (acc >= 80) {
                        strengths.push(topicName);
                    } else if (acc < 60) {
                        needsWork.push(topicName);
                    }
                }
            });
            
            report += `\nSTRENGTHS\n`;
            report += `---------\n`;
            report += strengths.length > 0 ? strengths.join(', ') + '\n' : 'Keep practicing to identify strengths!\n';
            
            report += `\nNEEDS ATTENTION\n`;
            report += `---------------\n`;
            report += needsWork.length > 0 ? needsWork.join(', ') + '\n' : 'Great progress so far!\n';
            
            report += `\nRECOMMENDATIONS\n`;
            report += `---------------\n`;
            report += `1. Focus on areas below 60% accuracy\n`;
            report += `2. Use hints when stuck to learn concepts\n`;
            report += `3. Practice 10-15 problems daily\n`;
            report += `4. Review step-by-step solutions carefully\n`;
            
            // Show the report
            document.getElementById('reportOutput').style.display = 'block';
            document.getElementById('reportText').textContent = report;
        }

        function showDetailedStats() {
            const detailsDiv = document.getElementById('detailedStats');
            
            if (detailsDiv.style.display === 'block') {
                detailsDiv.style.display = 'none';
                return;
            }
            
            let html = '<h4 style="color: #0369a1;">Problem-by-Problem Breakdown</h4>';
            
            if (problemHistory.length === 0) {
                html += '<p>No problems attempted yet.</p>';
            } else {
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #f0f9ff;">';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Time</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Topic</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Question</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid #e0e0e0;">Result</th>';
                html += '</tr></thead><tbody>';
                
                problemHistory.forEach(problem => {
                    const resultColor = problem.isCorrect ? '#10b981' : '#ef4444';
                    const resultText = problem.isCorrect ? '‚úÖ' : '‚ùå';
                    html += '<tr>';
                    html += `<td style="padding: 8px; border: 1px solid #e0e0e0;">${problem.timestamp}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #e0e0e0;">${problem.topic}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #e0e0e0; font-size: 0.9em;">${problem.question.substring(0, 50)}...</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #e0e0e0; color: ${resultColor};">${resultText}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            detailsDiv.innerHTML = html;
            detailsDiv.style.display = 'block';
        }

        function copyReport() {
            const reportText = document.getElementById('reportText').textContent;
            navigator.clipboard.writeText(reportText).then(() => {
                alert('Report copied to clipboard! You can now paste it in an email or message.');
            }).catch(() => {
                const textarea = document.createElement('textarea');
                textarea.value = reportText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Report copied to clipboard!');
            });
        }

        function exportProgress() {
            const data = {
                date: new Date().toISOString(),
                studentName: 'Jordan Lopez',
                ixlLevel: 460,
                totalAttempts: totalAttempts,
                correctAnswers: correctCount,
                accuracy: totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0,
                timeSpentMinutes: Math.floor((Date.now() - startTime) / 60000),
                topicStats: topicStats,
                problemHistory: problemHistory
            };
            
            const jsonData = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jordan-math-progress-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Progress saved! You can open this file later to review Jordan\'s work.');
        }

        function resetProgress() {
            // Confirm before resetting
            const confirmReset = confirm(
                "‚ö†Ô∏è Reset Progress?\n\n" +
                "This will:\n" +
                "‚Ä¢ Reset projected level to 460\n" +
                "‚Ä¢ Clear all completed problems\n" +
                "‚Ä¢ Reset accuracy statistics\n" +
                "‚Ä¢ Start fresh with 0 problems completed\n\n" +
                "Are you sure you want to reset?"
            );
            
            if (!confirmReset) {
                return;
            }
            
            // Reset all variables
            completedProblems = 0;
            totalAttempts = 0;
            correctCount = 0;
            startTime = Date.now();
            problemHistory = [];
            
            // Reset topic statistics
            topicStats = {
                fractions: { attempted: 0, correct: 0 },
                operations: { attempted: 0, correct: 0 },
                algebra: { attempted: 0, correct: 0 },
                'word-problems': { attempted: 0, correct: 0 },
                geometry: { attempted: 0, correct: 0 },
                measurement: { attempted: 0, correct: 0 },
                ratios: { attempted: 0, correct: 0 },
                integers: { attempted: 0, correct: 0 },
                expressions: { attempted: 0, correct: 0 }
            };
            
            // Update UI
            updateProgress();
            updateParentDashboard();
            
            // Clear localStorage
            try {
                localStorage.removeItem('jordanMathProgress');
            } catch(e) {
                console.log('Could not clear localStorage');
            }
            
            // Clear Firebase data if available
            if (firebaseAvailable && db) {
                db.collection('users').doc(userId).delete()
                    .then(() => {
                        showSyncStatus('üîÑ Progress reset to 460');
                        console.log('Firebase data cleared');
                    })
                    .catch(error => {
                        console.error('Error clearing Firebase:', error);
                        showSyncStatus('‚ö†Ô∏è Reset locally - cloud sync pending');
                    });
            } else {
                showSyncStatus('üîÑ Progress reset to 460 (local only)');
            }
            
            // Show success message
            alert('‚úÖ Progress has been reset!\n\nJordan is starting fresh at level 460.');
        }

        // Add a quick reset function for testing (without confirmation)
        function quickReset() {
            // This function can be called from console for testing
            // Type: quickReset() in browser console
            completedProblems = 0;
            totalAttempts = 0;
            correctCount = 0;
            startTime = Date.now();
            problemHistory = [];
            topicStats = {
                fractions: { attempted: 0, correct: 0 },
                operations: { attempted: 0, correct: 0 },
                algebra: { attempted: 0, correct: 0 },
                'word-problems': { attempted: 0, correct: 0 },
                geometry: { attempted: 0, correct: 0 },
                measurement: { attempted: 0, correct: 0 },
                ratios: { attempted: 0, correct: 0 },
                integers: { attempted: 0, correct: 0 },
                expressions: { attempted: 0, correct: 0 }
            };
            updateProgress();
            updateParentDashboard();
            db.collection('users').doc(userId).delete();
            showSyncStatus('üîÑ Quick reset completed');
        }

        // Add function to set custom progress (for testing different levels)
        function setProgress(problems, correct) {
            // This can be called from console for testing
            // Example: setProgress(50, 45) sets 50 attempts with 45 correct
            completedProblems = problems;
            totalAttempts = problems;
            correctCount = correct;
            updateProgress();
            updateParentDashboard();
            showSyncStatus(`üìä Set to ${problems} problems, ${correct} correct`);
        }
        window.onload = function() {
            // Load progress from Firebase first
            loadProgressFromFirebase();
            
            // Set up real-time sync
            db.collection('users').doc(userId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Don't update if this device just made the change
                        if (data.lastUpdated && new Date(data.lastUpdated).getTime() > Date.now() - 5000) {
                            return; // Skip if update was within last 5 seconds from this device
                        }
                        
                        // Update from another device's changes
                        completedProblems = data.completedProblems || completedProblems;
                        totalAttempts = data.totalAttempts || totalAttempts;
                        correctCount = data.correctCount || correctCount;
                        topicStats = data.topicStats || topicStats;
                        
                        updateProgress();
                        updateParentDashboard();
                        showSyncStatus('üîÑ Progress synced from another device');
                    }
                });
            
            // Update time every minute
            setInterval(() => {
                const timeElapsed = Math.floor((Date.now() - startTime) / 60000);
                document.getElementById('timeSpent').textContent = timeElapsed + 'm';
            }, 60000);
            
            // Save to Firebase periodically (every 30 seconds)
            setInterval(() => {
                if (totalAttempts > 0) {
                    saveProgressToLocal();
                }
            }, 30000);
        };
    </script>
</body>
</html>
